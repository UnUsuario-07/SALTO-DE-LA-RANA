<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { getDatabase, ref, set, push, update } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics.js";

    // Configuración de Firebase (se mantiene igual)
    const firebaseConfig = {
        apiKey: "AIzaSyB3wLx5mtJLjODg6qNrWl76v2nka_Bhvq8",
        authDomain: "salto-de-la-rana-ab7f9.firebaseapp.com",
        databaseURL: "https://salto-de-la-rana-ab7f9-default-rtdb.firebaseio.com",
        projectId: "salto-de-la-rana-ab7f9",
        storageBucket: "salto-de-la-rana-ab7f9.appspot.com",
        messagingSenderId: "891977313658",
        appId: "1:891977313658:web:5d0f2be7d60cf425e73ac3",
        measurementId: "G-Z56995RQ2J"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const analytics = getAnalytics(app);

    // Variables del juego
    let moves = 0;
    let frogs = [];
    let currentLevel = 3;
    let currentPlayer = null;
    let startTime = null;
    let gameId = null;

    // Función para sanitizar nombres para Firebase
    function sanitizeForFirebase(input) {
        return input.replace(/[.$#[\]/]/g, '_');
    }

    // Función para registrar eventos con estructura detallada
    async function logEventToFirebase(eventType, eventData) {
        try {
            const timestamp = new Date().toISOString();
            const now = Date.now();
            const playerKey = currentPlayer ? sanitizeForFirebase(currentPlayer) : 'anonimo';
            
            // Referencia base del jugador
            const playerRef = ref(database, `jugadores/${playerKey}`);
            
            // Si es un nuevo juego, inicializamos la estructura
            if (eventType === 'juego_iniciado') {
                gameId = `partida_${now}`;
                
                // Creamos la estructura inicial de la partida dentro del jugador
                const gameData = {
                    estado: 'en_progreso',
                    nivel: currentLevel,
                    inicio: timestamp,
                    movimientos: 0,
                    errores: 0,
                    configuracion: {
                        ranas_verdes: currentLevel,
                        ranas_rojas: currentLevel,
                        espacios: 1
                    },
                    tablero_inicial: JSON.stringify(frogs)
                };
                
                await set(ref(database, `jugadores/${playerKey}/partidas/${gameId}`), gameData);
                
                // Actualizamos estadísticas del jugador
                await update(playerRef, {
                    ultima_partida: timestamp,
                    nombre: currentPlayer || 'anonimo'
                });
            }
            
            // Procesamos diferentes tipos de eventos
            const updates = {};
            const eventPath = `jugadores/${playerKey}/partidas/${gameId}`;
            
            switch(eventType) {
                case 'movimiento':
                    updates[`${eventPath}/movimientos`] = moves;
                    updates[`${eventPath}/ultimo_movimiento`] = timestamp;
                    updates[`${eventPath}/movimientos_detalle/${moves}`] = {
                        ...eventData,
                        timestamp,
                        tablero_actual: JSON.stringify(frogs),
                        numero_movimiento: moves,
                        tiempo_transcurrido: (new Date() - startTime) / 1000
                    };
                    break;
                    
                case 'movimiento_invalido':
                    updates[`${eventPath}/errores`] = (await get(ref(database, `${eventPath}/errores`))).val() || 0) + 1;
                    updates[`${eventPath}/errores_detalle/${now}`] = {
                        ...eventData,
                        timestamp,
                        tablero_actual: JSON.stringify(frogs),
                        movimiento_intentado: moves + 1
                    };
                    break;
                    
                case 'partida_completada':
                    updates[`${eventPath}/estado`] = 'completada';
                    updates[`${eventPath}/resultado`] = 'victoria';
                    updates[`${eventPath}/fin`] = timestamp;
                    updates[`${eventPath}/duracion_segundos`] = eventData.tiempoSegundos;
                    updates[`${eventPath}/movimientos_totales`] = moves;
                    updates[`${eventPath}/tablero_final`] = JSON.stringify(frogs);
                    break;
            }
            
            // Aplicamos todas las actualizaciones
            await update(ref(database), updates);
            
            // También registramos el evento en Analytics
            logEvent(analytics, eventType, {
                ...eventData,
                jugador: currentPlayer || 'anonimo',
                nivel: currentLevel
            });
            
        } catch (e) {
            console.error("Error al registrar evento:", e);
        }
    }

    // Inicializar juego (se mantiene igual)
    function initGame() {
        currentLevel = parseInt(document.getElementById('level').value);
        moves = 0;
        document.getElementById('moves').textContent = `Movimientos: ${moves}`;
        
        frogs = [
            ...Array(currentLevel).fill('green'),
            'empty',
            ...Array(currentLevel).fill('red')
        ];
        
        startTime = new Date();
        renderBoard();
        logEventToFirebase('juego_iniciado', { movimientos: moves });
    }

    // Renderizar tablero (se mantiene igual)
    function renderBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        
        frogs.forEach((frog, index) => {
            const div = document.createElement('div');
            if (frog === 'empty') {
                div.className = 'empty';
                div.addEventListener('click', () => moveFrog(index));
            } else {
                div.className = `frog ${frog}`;
                div.textContent = frog === 'green' ? '→' : '←';
                div.addEventListener('click', () => moveFrog(index));
            }
            board.appendChild(div);
        });
    }

    // Mover rana con registro detallado
    function moveFrog(index) {
        const frog = frogs[index];
        if (frog === 'empty') return;

        const direction = frog === 'green' ? 1 : -1;
        const nextIndex = index + direction;
        const prevIndex = index - direction;
        const jumpIndex = index + 2 * direction;
        const backJumpIndex = index - 2 * direction;

        // Detalles comunes para el registro
        const moveDetails = {
            rana_movida: index,
            color: frog,
            tablero_antes: JSON.stringify(frogs),
            tiempo_transcurrido: (new Date() - startTime) / 1000
        };

        // Movimiento simple hacia adelante
        if (frogs[nextIndex] === 'empty') {
            [frogs[index], frogs[nextIndex]] = [frogs[nextIndex], frogs[index]];
            moves++;
            logEventToFirebase('movimiento', {
                ...moveDetails,
                tipo: 'simple_adelante',
                destino: nextIndex,
                salto: false,
                sobre_rana: null
            });
        } 
        // Movimiento simple hacia atrás
        else if (frogs[prevIndex] === 'empty') {
            [frogs[index], frogs[prevIndex]] = [frogs[prevIndex], frogs[index]];
            moves++;
            logEventToFirebase('movimiento', {
                ...moveDetails,
                tipo: 'simple_atras',
                destino: prevIndex,
                salto: false,
                sobre_rana: null
            });
        }
        // Salto hacia adelante
        else if (frogs[nextIndex] && frogs[jumpIndex] === 'empty') {
            const sobreRana = frogs[nextIndex];
            [frogs[index], frogs[jumpIndex]] = [frogs[jumpIndex], frogs[index]];
            moves++;
            logEventToFirebase('movimiento', {
                ...moveDetails,
                tipo: 'salto_adelante',
                destino: jumpIndex,
                salto: true,
                sobre_rana: {
                    posicion: nextIndex,
                    color: sobreRana,
                    misma_direccion: sobreRana === frog
                }
            });
        }
        // Salto hacia atrás
        else if (frogs[prevIndex] && frogs[backJumpIndex] === 'empty') {
            const sobreRana = frogs[prevIndex];
            [frogs[index], frogs[backJumpIndex]] = [frogs[backJumpIndex], frogs[index]];
            moves++;
            logEventToFirebase('movimiento', {
                ...moveDetails,
                tipo: 'salto_atras',
                destino: backJumpIndex,
                salto: true,
                sobre_rana: {
                    posicion: prevIndex,
                    color: sobreRana,
                    misma_direccion: sobreRana === frog
                }
            });
        } else {
            logEventToFirebase('movimiento_invalido', {
                ...moveDetails,
                intento_destino: nextIndex,
                razon: 'movimiento_no_permitido'
            });
            return;
        }

        document.getElementById('moves').textContent = `Movimientos: ${moves}`;
        renderBoard();
        checkWin();
    }

    // Verificar victoria (se mantiene igual)
    function checkWin() {
        const winState = [
            ...Array(currentLevel).fill('red'),
            'empty',
            ...Array(currentLevel).fill('green')
        ];
        
        if (JSON.stringify(frogs) === JSON.stringify(winState)) {
            const endTime = new Date();
            const tiempo = (endTime - startTime) / 1000;
            
            logEventToFirebase('partida_completada', {
                movimientos: moves,
                tiempoSegundos: tiempo,
                nivel: currentLevel,
                tablero_final: JSON.stringify(frogs)
            });
            
            setTimeout(() => alert(`¡${currentPlayer || 'Jugador'} ganó en ${moves} movimientos! 🎉`), 100);
        }
    }

    // Event listeners (se mantienen igual)
    document.getElementById('start-game').addEventListener('click', () => {
        const playerName = document.getElementById('player-name').value.trim();
        if (!playerName) {
            alert("¡Ingresa un nombre!");
            return;
        }
        currentPlayer = playerName;
        document.getElementById('player-setup').classList.add('hidden');
        document.getElementById('game-controls').classList.remove('hidden');
        initGame();
    });

    document.getElementById('reset').addEventListener('click', initGame);
    document.getElementById('level').addEventListener('change', initGame);
</script>
